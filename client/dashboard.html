<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard – SARMS</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Your original CSS – untouched */
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { 
      margin: 0; background-color: #f3f3f3; display: flex; color: #000; transition: background 0.3s; 
    }
    .sidebar {
       width: 240px; background-color: #007A33; color: white; height: 100vh; padding: 30px 20px; position: fixed; display: flex; flex-direction: column; justify-content: space-between; 
      }
    .sidebar h2 { 
      font-size: 24px; margin-bottom: 30px; 
    }
    .sidebar ul {
       list-style: none; padding: 0; 
      }
    .sidebar ul li { 
      padding: 12px 10px; font-size: 16px; cursor: pointer; border-radius: 8px; transition: background 0.3s; 
    }
    .sidebar ul li:hover {
       background-color: #005A22; 
      }
    .sidebar .footer {
       font-size: 12px; opacity: 0.7; text-align: center; 
      }
    .main-content {
       margin-left: 260px; padding: 30px; width: 100%; 
      }
    .topbar {
       display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; 
      }
    .buttons { 
      display: flex; gap: 10px; 
    }
    button {
       padding: 10px 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; 
      }
    .logout { 
      background-color: #c0392b; color: white; 
    }
    .logout:hover {
       background-color: #a93226; 
      }
    .export-btn {
       background-color: #007BFF; color: white; 
      }
    .export-btn:hover {
       background-color: #0056b3; 
      }
    .toggle-mode {
       background-color: #ddd; 
      }
    .container {
       background: rgba(255, 255, 255, 0.9); padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
      }
    h2, h3 {
       color: #007A33; margin-bottom: 16px; 
      }
    .info-box, .cgpa-box, .error-message {
       background: #ffffff; padding: 16px 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 24px; 
      }
    .cgpa-box {
       background-color: #d1f2e2; color: #006644; font-weight: 600; text-align: center; 
      }
    table {
       width: 100%; border-collapse: collapse; margin-top: 20px; 
      }
    th, td {
       padding: 12px; text-align: center; border: 1px solid #ddd; 
      }
    th {
       background-color: #007A33; color: white; 
      }
    .chart-container {
       margin-top: 40px; background-color: #fff; padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); 
      }
  </style>
</head>
<body>
  <div class="sidebar">
    <div>
      <h2>SARMS</h2>
      <ul>
        <li>Dashboard</li>
        <li>Transcript</li>
        <li onclick="exportToPDF()">Export PDF</li>
        <li onclick="logout()">Logout</li>
      </ul>
    </div>
    <div class="footer">&copy; 2025 SARMS</div>
  </div>

  <div class="main-content">
    <div class="topbar">
      <h2>Welcome, <span id="studentName">...</span> 23CH034235</h2>
      <div class="buttons">
        <button class="toggle-mode" id="modeBtn" onclick="toggleMode()">Dark Mode</button>
        <button class="export-btn" onclick="exportToPDF()">Export PDF</button>
        <button class="logout" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="container">
      <div id="errorBox" class="error-message" style="display: none;"></div>
      <div class="info-box" id="studentInfo"></div>

      <h3>Transcript</h3>
      <table>
        <thead>
          <tr>
            <th>Course Code</th>
            <th>Title</th>
            <th>Unit</th>
            <th>Grade</th>
            <th>GPA Point</th>
          </tr>
        </thead>
        <tbody id="transcriptBody"></tbody>
      </table>

      <div class="cgpa-box" id="cgpaBox">GPA: --</div>

      <div class="chart-container">
        <h3>GPA Trend (Alpha/Omega Semesters)</h3>
        <canvas id="gpaTrendChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const matric = localStorage.getItem("matric");
    if (!matric) window.location.href = "login.html";

    function logout() {
      localStorage.removeItem("matric");
      window.location.href = "login.html";
    }

    function toggleMode() {
      const body = document.body;
      const modeBtn = document.getElementById("modeBtn");
      body.classList.toggle("dark");
      const dark = body.classList.contains("dark");
      body.style.backgroundColor = dark ? "#121212" : "#f3f3f3";
      modeBtn.textContent = dark ? "Light Mode" : "Dark Mode";
    }

    async function loadStudentData() {
      const nameEl = document.getElementById("studentName");
      const infoEl = document.getElementById("studentInfo");
      const tbody = document.getElementById("transcriptBody");
      const cgpaBox = document.getElementById("cgpaBox");
      const errorBox = document.getElementById("errorBox");

        const res = await fetch(`http://localhost:3000/student/${matric}`);
        const data = await res.json();

        if (!data || !data.student || !data.courses) {
          errorBox.style.display = "block";
          errorBox.innerText = "No student record or courses found.";
          return;
        }

        nameEl.textContent = data.student.FullName;
        infoEl.innerHTML = `<p><strong>${data.student.Level} Level – ${data.student.Department}</strong></p>`;

        let totalUnits = 0, totalPoints = 0;
        tbody.innerHTML = "";

        data.courses.forEach(course => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${course.CourseCode}</td>
            <td>${course.Title}</td>
            <td>${course.CreditUnits}</td>
            <td>${course.LetterGrade}</td>
            <td>${course.GPAPoints}</td>
          `;
          tbody.appendChild(row);
          totalUnits += course.CreditUnits;
          totalPoints += course.GPAPoints * course.CreditUnits;
        });

        const gpa = totalUnits ? (totalPoints / totalUnits).toFixed(2) : "0.00";
        const gpaClass = gpa >= 4.5 ? "First Class" :
                         gpa >= 3.5 ? "Second Class Upper" :
                         gpa >= 2.4 ? "Second Class Lower" :
                         gpa >= 1.5 ? "Third Class" :
                         gpa >= 1.0 ? "Pass" : "Fail";
        cgpaBox.innerText = `GPA: ${gpa} — ${gpaClass}`;

        const ctx = document.getElementById("gpaTrendChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: ["2023/2024 Alpha", "2023/2024 Omega", "2024/2025 Omega"],
            datasets: [{
              label: "GPA",
              data: [4.2, 3.1, parseFloat(gpa)],
              borderColor: "#007A33",
              backgroundColor: "rgba(0, 122, 51, 0.2)",
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            scales: { y: { beginAtZero: true, max: 5 } }
          }
        });

      }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "landscape" });

      const name = document.getElementById("studentName").textContent;
      const info = document.getElementById("studentInfo").textContent;
      const cgpa = document.getElementById("cgpaBox").textContent;

      let x = 15, y = 20;
      doc.setFont("Helvetica", "bold");
      doc.setFontSize(18);
      doc.text("COVENANT UNIVERSITY", x, y);
      doc.setFontSize(14);
      doc.text("Student Academic Transcript", x, y + 10);

      y += 30;
      doc.setFont("Helvetica", "normal");
      doc.setFontSize(12);
      doc.text(`Name: ${name}`, x, y);
      doc.text(`Info: ${info}`, x + 120, y);
      y += 10;

      doc.setFont("Helvetica", "bold");
      doc.text("Course Code", x, y);
      doc.text("Title", x + 40, y);
      doc.text("Unit", x + 110, y);
      doc.text("Grade", x + 130, y);
      doc.text("GPA Point", x + 160, y);
      y += 8;

      const rows = document.querySelectorAll("#transcriptBody tr");
      doc.setFont("Helvetica", "normal");
      rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        if (cells.length >= 5) {
          doc.text(cells[0].innerText, x, y);
          doc.text(cells[1].innerText, x + 40, y);
          doc.text(cells[2].innerText, x + 110, y);
          doc.text(cells[3].innerText, x + 130, y);
          doc.text(cells[4].innerText, x + 160, y);
          y += 8;
        }
      });

      y += 10;
      doc.setFont("Helvetica", "bold");
      doc.text(cgpa, x, y);
      doc.save("transcript.pdf");
    }

    loadStudentData();
  </script>
</body>
</html>
